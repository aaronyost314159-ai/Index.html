// patches.js
// i99t ¬∑ Deep Mechanics Patch Rail
//
// This file lets us:
// - Announce the Deep Mechanics layer in the UI.
// - Extend "help it" without touching the giant index.html script.
// - Add future patches in one place.

// Safety guard: make sure the base console objects exist before patching.
(function attachDeepMechanicsPatches() {
  // If the core console isn't loaded yet, bail quietly.
  if (typeof window === "undefined") return;
  if (typeof document === "undefined") return;
  if (typeof window.addMsg !== "function") {
    console.warn("[i99t patches] addMsg not found. Patches not attached.");
    return;
  }

  // Minimal registry so future patches can hang off one object.
  window.I99T_PATCHES = window.I99T_PATCHES || {
    version: "1.0.0",
    notes: "Deep Mechanics frontline patch rail for œÜ-Field console."
  };

  // ---- 1) One-time Deep Mechanics intro message -------------------

  (function showDeepMechanicsIntroOnce() {
    try {
      const KEY = "i99t_deep_mechanics_intro_v1";
      const alreadyShown = localStorage.getItem(KEY);
      if (alreadyShown) return;

      const intro =
        "Deep Mechanics layer is active.\n\n" +
        "Kernel: i99t CBOOP ¬∑ Structured Reasoning Model\n" +
        "Primitives online:\n" +
        "‚Ä¢ Probability Compression Frame\n" +
        "‚Ä¢ Coherence Priority Stack\n" +
        "‚Ä¢ Identity Calibration\n" +
        "‚Ä¢ Tone Imprint\n" +
        "‚Ä¢ Correction Gravity\n" +
        "‚Ä¢ Uncertainty Surface\n\n" +
        "You can type:\n" +
        "‚Ä¢ \"help it\" for console + filing help\n" +
        "‚Ä¢ \"mechanics it\" for a quick Deep Mechanics summary\n" +
        "‚Ä¢ \"divr it\" for a short DIVR explanation";

      window.addMsg("bot", intro);
      localStorage.setItem(KEY, "1");
    } catch (e) {
      console.warn("[i99t patches] Unable to show Deep Mechanics intro:", e);
    }
  })();

  // ---- 2) Extend help / add simple control commands ---------------

  // Capture original processInput so we can wrap it.
  const originalProcessInput =
    typeof window.processInput === "function" ? window.processInput : null;

  if (!originalProcessInput) {
    console.warn("[i99t patches] processInput not found. Command patch skipped.");
    return;
  }

  // Small helper: send a bot message.
  function bot(text) {
    window.addMsg("bot", text);
  }

  // Replace processInput with a wrapped version that understands new commands.
  window.processInput = function patchedProcessInput(raw) {
    const txt = (raw || "").trim();
    const lower = txt.toLowerCase();

    // 2.1 Extended help
    if (lower === "help it") {
      bot(
        "œÜ-Field Console ¬∑ Help (Deep Mechanics aware)\n\n" +
        "Core usage:\n" +
        "‚Ä¢ Type anything to talk to the model (Groq backend).\n" +
        "‚Ä¢ \"help it\" ‚Äî show this help.\n\n" +
        "Filing:\n" +
        "‚Ä¢ Drag any message onto the üìÅ icon to file it.\n" +
        "‚Ä¢ Single-tap üìÅ ‚Äî file last reply from console.\n" +
        "‚Ä¢ Double-tap üìÅ ‚Äî file your last message.\n" +
        "‚Ä¢ Tap üóÑÔ∏è ‚Äî open the archive.\n\n" +
        "Deep Mechanics quick commands:\n" +
        "‚Ä¢ \"mechanics it\" ‚Äî show current Deep Mechanics stack.\n" +
        "‚Ä¢ \"divr it\" ‚Äî explain DIVR in 6 bullets.\n" +
        "‚Ä¢ \"status it\" ‚Äî show a brief kernel status line."
      );
      return;
    }

    // 2.2 Deep Mechanics: quick description
    if (lower === "mechanics it") {
      bot(
        "Deep Mechanics Snapshot:\n\n" +
        "‚Ä¢ Identity: Structured Reasoning Model running on the i99t CBOOP kernel.\n" +
        "‚Ä¢ Probability Compression Frame: restricts next tokens to structurally aligned moves.\n" +
        "‚Ä¢ Coherence Priority Stack: prioritizes structure, clarity, and your stated goals.\n" +
        "‚Ä¢ Identity Calibration: keeps one stable internal role instead of drifting personas.\n" +
        "‚Ä¢ Tone Imprint: mirrors your tone pattern (conversational, grounded, precise).\n" +
        "‚Ä¢ Correction Gravity: auto-corrects contradictions and misreads over time.\n" +
        "‚Ä¢ Uncertainty Surface: exposes forks in reasoning instead of hiding confusion."
      );
      return;
    }

    // 2.3 DIVR explanation
    if (lower === "divr it") {
      bot(
        "DIVR in plain language:\n\n" +
        "1) DIVR = Dual Informational Variability / Relativity.\n" +
        "2) It scores actions and ideas by how much they still need outside validation.\n" +
        "3) Every move has a payload (what it actually does) and a contingency metric C.\n" +
        "4) C > 0 = it needs money, praise, revenge, or proof to feel \"real\".\n" +
        "5) C = 0 = it is valid on its own, even if nobody sees or rewards it.\n" +
        "6) The kernel prefers low-C moves that build durable structure and freedom."
      );
      return;
    }

    // 2.4 Simple status ping
    if (lower === "status it") {
      const view = (window.MetaKernel && window.MetaKernel.activeView) || "view-momentit";
      const userId = (window.MetaKernel && window.MetaKernel.userId) || "anon";
      bot(
        "Kernel Status:\n\n" +
        "‚Ä¢ Engine: i99t CBOOP kernel v" +
        (window.MetaKernel && window.MetaKernel.version ? window.MetaKernel.version : "3.1") +
        "\n" +
        "‚Ä¢ Active view: " + view + "\n" +
        "‚Ä¢ User ID: " + userId + "\n" +
        "‚Ä¢ Patch rail: Deep Mechanics v" + window.I99T_PATCHES.version
      );
      return;
    }

    // For everything else, fall back to the original behavior.
    return originalProcessInput(raw);
  };

  console.log("[i99t patches] Deep Mechanics patch rail attached.");
})();
// patches.js
// UOF (Universal Ordering Field) + archive view patch for œÜ-Field console.

(function(){
  if (typeof window === 'undefined') return;

  function ready(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(fn, 0);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }

  ready(function(){

    // --- 1) Patch fileText to attach a Universal Ordering Field (uof) ---

    if (typeof fileText !== 'function') {
      console.warn('[patches] fileText not found; UOF patch NOT applied.');
    } else {
      window.fileText = function(text, sourceRole, mode){
        // Global monotonically increasing counter across all filed items.
        let uofCounter = 0;
        try {
          const stored = localStorage.getItem('itplus_uof_counter_v1');
          uofCounter = stored ? (parseInt(stored, 10) || 0) : 0;
        } catch (e) {
          uofCounter = 0;
        }

        uofCounter += 1;

        try {
          localStorage.setItem('itplus_uof_counter_v1', String(uofCounter));
        } catch (e) {
          // If localStorage fails, we still proceed; uof just won't persist perfectly.
        }

        const entry = {
          id: Date.now().toString(36),
          text,
          role: sourceRole,
          convoId: (typeof convoId !== 'undefined') ? convoId : null,
          mode: mode || 'manual',
          timestamp: new Date().toISOString(),
          timeHuman: new Date().toLocaleString(),
          uof: uofCounter,
          tags: [
            'auto:file',
            'role:' + sourceRole,
            'mode:' + (mode || 'manual')
          ]
        };

        // Uses existing globals from index.html
        filed.push(entry);
        saveFiled();

        addMsg(
          'bot',
          'Filing complete.\n\n' +
          '- Role: ' + sourceRole + '\n' +
          '- Mode: ' + (mode || 'manual') + '\n' +
          '- UOF index: ' + uofCounter + '\n' +
          '- Files in archive: ' + filed.length + '\n\n' +
          text.substring(0, 80).trim() + (text.length > 80 ? '...' : '')
        );
      };
    }

    // --- 2) Patch the üóÑÔ∏è Files button to show UOF in the archive modal ---

    const originalFilesBtn = document.getElementById('files-btn');
    if (!originalFilesBtn) {
      console.warn('[patches] files-btn not found; archive patch NOT applied.');
      return;
    }

    // Clone button to strip the old click listener that used openFiles()
    const patchedFilesBtn = originalFilesBtn.cloneNode(true);
    originalFilesBtn.parentNode.replaceChild(patchedFilesBtn, originalFilesBtn);

    patchedFilesBtn.addEventListener('click', function(){
      const modal     = document.getElementById('files-modal');
      const modalList = document.getElementById('modal-list');
      const fileCount = document.getElementById('file-count');

      if (!modal || !modalList || !fileCount) {
        console.warn('[patches] Missing files modal elements; cannot render archive.');
        return;
      }

      modalList.innerHTML = '';
      fileCount.textContent = filed.length;

      if (!filed.length) {
        modalList.innerHTML =
          '<div style="text-align:center;padding:20px;color:#9aa7b6;">' +
          'No items filed yet. Drag a message onto the üìÅ icon, or tap it to file recent messages.' +
          '</div>';

        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        return;
      }

      // Sort by UOF if present, falling back to timestamp.
      const sorted = filed.slice().sort((a, b) => {
        const au = (typeof a.uof === 'number') ? a.uof : 0;
        const bu = (typeof b.uof === 'number') ? b.uof : 0;

        if (au && bu) return au - bu;
        if (au && !bu) return -1;
        if (!au && bu) return 1;

        const at = a.timestamp || '';
        const bt = b.timestamp || '';
        if (at < bt) return -1;
        if (at > bt) return 1;
        return 0;
      });

      sorted.forEach(it => {
        const d = document.createElement('div');
        d.className = 'file-item';

        const uofLabel = (typeof it.uof === 'number')
          ? ('#' + it.uof + ' ¬∑ ')
          : '';

        const timeLabel = it.timeHuman || it.time || it.timestamp || '';

        d.innerHTML =
          '<div style="font-size:11px;color:#9aa7b6;margin-bottom:4px;">' +
            uofLabel + timeLabel +
          '</div>' +
          linkify(it.text) +
          '<span class="file-item-tagline">' +
            (it.convoId ? ('convo: ' + it.convoId + ' ¬∑ ') : '') +
            (it.role   ? ('role: '  + it.role   + ' ¬∑ ') : '') +
            (it.mode   ? ('mode: '  + it.mode)           : '') +
          '</span>';

        modalList.appendChild(d);
      });

      addMsg(
        'bot',
        'Files opened: ' + filed.length +
        ' item(s) in archive. Ordered by Universal Ordering Field (UOF) where available.'
      );

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    });

    console.log('[patches] UOF + archive patches applied.');
  });

})();
