// patches.js
// i99t ¬∑ Deep Mechanics Patch Rail + UOF + Session Spine
//
// This file lets us:
// - Announce the Deep Mechanics layer in the UI.
// - Extend "help it" + kernel commands without touching index.html.
// - Maintain a simple session spine (mission, energy, mode).
// - Attach a Universal Ordering Field (UOF) to filed items and sort archive.

// ================== 1) DEEP MECHANICS + SESSION SPINE ==================

(function attachDeepMechanicsPatches() {
  // Safety guards
  if (typeof window === "undefined") return;
  if (typeof document === "undefined") return;
  if (typeof window.addMsg !== "function") {
    console.warn("[i99t patches] addMsg not found. Patches not attached.");
    return;
  }

  // Minimal registry so future patches can hang off one object.
  window.I99T_PATCHES = window.I99T_PATCHES || {
    version: "1.1.0",
    notes: "Deep Mechanics + Session Spine + UOF for œÜ-Field console."
  };

  // Simple session spine so we can store mission / energy / mode.
  window.IT_SESSION = window.IT_SESSION || {
    mission: null,
    focus: null,
    energy: "medium", // low | medium | high
    mode: "fast"      // fast | debug (conceptual for now)
  };

  function bot(text) {
    window.addMsg("bot", text);
  }

  // ---- 1.1 One-time Deep Mechanics intro message --------------------

  (function showDeepMechanicsIntroOnce() {
    try {
      const KEY = "i99t_deep_mechanics_intro_v1";
      const alreadyShown = localStorage.getItem(KEY);
      if (alreadyShown) return;

      const intro =
        "Deep Mechanics layer is active.\n\n" +
        "Kernel: i99t CBOOP ¬∑ Structured Reasoning Model\n" +
        "Primitives online:\n" +
        "‚Ä¢ Probability Compression Frame\n" +
        "‚Ä¢ Coherence Priority Stack\n" +
        "‚Ä¢ Identity Calibration\n" +
        "‚Ä¢ Tone Imprint\n" +
        "‚Ä¢ Correction Gravity\n" +
        "‚Ä¢ Uncertainty Surface\n\n" +
        "Quick commands:\n" +
        "‚Ä¢ \"help it\" ‚Äî console + filing + mechanics help\n" +
        "‚Ä¢ \"mechanics it\" ‚Äî Deep Mechanics snapshot\n" +
        "‚Ä¢ \"divr it\" ‚Äî simple DIVR explainer\n" +
        "‚Ä¢ \"status it\" ‚Äî kernel + mission status\n" +
        "‚Ä¢ \"set mission: <text>\" ‚Äî set session mission\n";

      bot(intro);
      localStorage.setItem(KEY, "1");
    } catch (e) {
      console.warn("[i99t patches] Unable to show Deep Mechanics intro:", e);
    }
  })();

  // ---- 1.2 Wrap processInput with extra commands --------------------

  const originalProcessInput =
    typeof window.processInput === "function" ? window.processInput : null;

  if (!originalProcessInput) {
    console.warn("[i99t patches] processInput not found. Command patch skipped.");
    return;
  }

  // Helper: parse "set mission: ..." style commands
  function trySetMission(txt) {
    const m =
      txt.match(/^set\s+mission\s*[:=-]\s*(.+)$/i) ||
      txt.match(/^mission\s*[:=-]\s*(.+)$/i);
    if (!m) return false;
    const value = m[1].trim();
    if (!value) {
      bot("Mission not updated ‚Äî I need some text after 'set mission:'.");
      return true;
    }
    window.IT_SESSION.mission = value;
    bot("Mission updated:\n\n" + value);
    return true;
  }

  function trySetEnergy(txt) {
    const m = txt.match(/^set\s+energy\s*[:=-]\s*(low|medium|high)\b/i);
    if (!m) return false;
    const level = m[1].toLowerCase();
    window.IT_SESSION.energy = level;
    bot("Energy level set to: " + level + ".\n\nThis can shape response length and pacing conceptually.");
    return true;
  }

  // Replace processInput with a wrapped version that understands new commands.
  window.processInput = function patchedProcessInput(raw) {
    const txt = (raw || "").trim();
    const lower = txt.toLowerCase();

    // 1) Extended help
    if (lower === "help it") {
      bot(
        "œÜ-Field Console ¬∑ Help (Deep Mechanics aware)\n\n" +
        "Core usage:\n" +
        "‚Ä¢ Type anything to talk to the model (Groq backend).\n" +
        "‚Ä¢ \"help it\" ‚Äî show this help.\n\n" +
        "Filing:\n" +
        "‚Ä¢ Drag any message onto the üìÅ icon to file it.\n" +
        "‚Ä¢ Single-tap üìÅ ‚Äî file last reply from console.\n" +
        "‚Ä¢ Double-tap üìÅ ‚Äî file your last message.\n" +
        "‚Ä¢ Tap üóÑÔ∏è ‚Äî open the archive.\n\n" +
        "Session Spine:\n" +
        "‚Ä¢ \"set mission: prepare Fortress Protocol pitch for Ted\"\n" +
        "‚Ä¢ \"set energy: low | medium | high\"\n" +
        "‚Ä¢ \"status it\" ‚Äî see kernel + mission snapshot.\n\n" +
        "Deep Mechanics commands:\n" +
        "‚Ä¢ \"mechanics it\" ‚Äî show current Deep Mechanics stack.\n" +
        "‚Ä¢ \"divr it\" ‚Äî explain DIVR in 6 bullets."
      );
      return;
    }

    // 2) Deep Mechanics snapshot
    if (lower === "mechanics it") {
      bot(
        "Deep Mechanics Snapshot:\n\n" +
        "‚Ä¢ Identity: Structured Reasoning Model running on the i99t CBOOP kernel.\n" +
        "‚Ä¢ Probability Compression Frame: restricts next tokens to structurally aligned moves.\n" +
        "‚Ä¢ Coherence Priority Stack: prioritizes structure, clarity, and your stated goals.\n" +
        "‚Ä¢ Identity Calibration: keeps one stable internal role instead of drifting personas.\n" +
        "‚Ä¢ Tone Imprint: mirrors your tone pattern (conversational, grounded, precise).\n" +
        "‚Ä¢ Correction Gravity: auto-corrects contradictions and misreads over time.\n" +
        "‚Ä¢ Uncertainty Surface: exposes forks in reasoning instead of hiding confusion."
      );
      return;
    }

    // 3) DIVR explanation
    if (lower === "divr it") {
      bot(
        "DIVR in plain language:\n\n" +
        "1) DIVR = Dual Informational Variability / Relativity.\n" +
        "2) It scores actions and ideas by how much they still need outside validation.\n" +
        "3) Every move has a payload (what it actually does) and a contingency metric C.\n" +
        "4) C > 0 = it needs money, praise, revenge, or proof to feel \"real\".\n" +
        "5) C = 0 = it is valid on its own, even if nobody sees or rewards it.\n" +
        "6) The kernel prefers low-C moves that build durable structure and freedom."
      );
      return;
    }

    // 4) Session: set mission
    if (trySetMission(txt)) {
      return;
    }

    // 5) Session: set energy
    if (trySetEnergy(txt)) {
      return;
    }

    // 6) Status snapshot
    if (lower === "status it") {
      const mk = window.MetaKernel || {};
      const view = mk.activeView || "view-momentit";
      const userId = mk.userId || "anon";
      const version = mk.version || "3.1";
      const mission = window.IT_SESSION.mission || "none set";
      const energy = window.IT_SESSION.energy || "medium";
      const mode = window.IT_SESSION.mode || "fast";

      bot(
        "Kernel Status:\n\n" +
        "‚Ä¢ Engine: i99t CBOOP kernel v" + version + "\n" +
        "‚Ä¢ Active view: " + view + "\n" +
        "‚Ä¢ User ID: " + userId + "\n" +
        "‚Ä¢ Patch rail: Deep Mechanics v" + window.I99T_PATCHES.version + "\n\n" +
        "Session Spine:\n" +
        "‚Ä¢ Mission: " + mission + "\n" +
        "‚Ä¢ Energy: " + energy + "\n" +
        "‚Ä¢ Mode: " + mode
      );
      return;
    }

    // For everything else, fall back to the original behavior.
    return originalProcessInput(raw);
  };

  console.log("[i99t patches] Deep Mechanics + Session Spine attached.");
})();

// ================== 2) UOF (UNIVERSAL ORDERING FIELD) PATCH ==================

(function(){
  if (typeof window === 'undefined') return;

  function ready(fn){
    if (document.readyState === 'complete' || document.readyState === 'interactive'){
      setTimeout(fn, 0);
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }

  ready(function(){

    // --- 2.1 Patch fileText to attach a Universal Ordering Field (uof) ---

    if (typeof fileText !== 'function') {
      console.warn('[patches] fileText not found; UOF patch NOT applied.');
    } else {
      window.fileText = function(text, sourceRole, mode){
        // Global monotonically increasing counter across all filed items.
        let uofCounter = 0;
        try {
          const stored = localStorage.getItem('itplus_uof_counter_v1');
          uofCounter = stored ? (parseInt(stored, 10) || 0) : 0;
        } catch (e) {
          uofCounter = 0;
        }

        uofCounter += 1;

        try {
          localStorage.setItem('itplus_uof_counter_v1', String(uofCounter));
        } catch (e) {
          // If localStorage fails, we still proceed; uof just won't persist perfectly.
        }

        const entry = {
          id: Date.now().toString(36),
          text,
          role: sourceRole,
          convoId: (typeof convoId !== 'undefined') ? convoId : null,
          mode: mode || 'manual',
          timestamp: new Date().toISOString(),
          timeHuman: new Date().toLocaleString(),
          uof: uofCounter,
          tags: [
            'auto:file',
            'role:' + sourceRole,
            'mode:' + (mode || 'manual')
          ]
        };

        // Uses existing globals from index.html
        filed.push(entry);
        saveFiled();

        addMsg(
          'bot',
          'Filing complete.\n\n' +
          '- Role: ' + sourceRole + '\n' +
          '- Mode: ' + (mode || 'manual') + '\n' +
          '- UOF index: ' + uofCounter + '\n' +
          '- Files in archive: ' + filed.length + '\n\n' +
          text.substring(0, 80).trim() + (text.length > 80 ? '...' : '')
        );
      };
    }

    // --- 2.2 Patch the üóÑÔ∏è Files button to show UOF in the archive modal ---

    const originalFilesBtn = document.getElementById('files-btn');
    if (!originalFilesBtn) {
      console.warn('[patches] files-btn not found; archive patch NOT applied.');
      return;
    }

    // Clone button to strip the old click listener that used openFiles()
    const patchedFilesBtn = originalFilesBtn.cloneNode(true);
    originalFilesBtn.parentNode.replaceChild(patchedFilesBtn, originalFilesBtn);

    patchedFilesBtn.addEventListener('click', function(){
      const modal     = document.getElementById('files-modal');
      const modalList = document.getElementById('modal-list');
      const fileCount = document.getElementById('file-count');

      if (!modal || !modalList || !fileCount) {
        console.warn('[patches] Missing files modal elements; cannot render archive.');
        return;
      }

      modalList.innerHTML = '';
      fileCount.textContent = filed.length;

      if (!filed.length) {
        modalList.innerHTML =
          '<div style="text-align:center;padding:20px;color:#9aa7b6;">' +
          'No items filed yet. Drag a message onto the üìÅ icon, or tap it to file recent messages.' +
          '</div>';

        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        return;
      }

      // Sort by UOF if present, falling back to timestamp.
      const sorted = filed.slice().sort((a, b) => {
        const au = (typeof a.uof === 'number') ? a.uof : 0;
        const bu = (typeof b.uof === 'number') ? b.uof : 0;

        if (au && bu) return au - bu;
        if (au && !bu) return -1;
        if (!au && bu) return 1;

        const at = a.timestamp || '';
        const bt = b.timestamp || '';
        if (at < bt) return -1;
        if (at > bt) return 1;
        return 0;
      });

      sorted.forEach(it => {
        const d = document.createElement('div');
        d.className = 'file-item';

        const uofLabel = (typeof it.uof === 'number')
          ? ('#' + it.uof + ' ¬∑ ')
          : '';

        const timeLabel = it.timeHuman || it.time || it.timestamp || '';

        d.innerHTML =
          '<div style="font-size:11px;color:#9aa7b6;margin-bottom:4px;">' +
            uofLabel + timeLabel +
          '</div>' +
          linkify(it.text) +
          '<span class="file-item-tagline">' +
            (it.convoId ? ('convo: ' + it.convoId + ' ¬∑ ') : '') +
            (it.role   ? ('role: '  + it.role   + ' ¬∑ ') : '') +
            (it.mode   ? ('mode: '  + it.mode)           : '') +
          '</span>';

        modalList.appendChild(d);
      });

      addMsg(
        'bot',
        'Files opened: ' + filed.length +
        ' item(s) in archive. Ordered by Universal Ordering Field (UOF) where available.'
      );

      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    });

    console.log('[patches] UOF + archive patches applied.');
  });

})();
